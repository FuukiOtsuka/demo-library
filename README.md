## このリポジトリは何？

このリポジトリは、**図書管理アプリ** のバックエンド部分を管理するものです。

**NestJSフレームワーク**をベースに構築されており、リクエスト処理、ビジネスロジック、データ永続化（**Firebase**）など、  
サーバーレス環境におけるAPI提供機能を担当します。  
特に、Node.js環境を持たないWorkersでNestJSを安定稼働させるための独自の工夫（**シムファイルの利用**）を含んでいます。

---

## 設計思想

本プロジェクトは「**高速開発 × NestJS標準構成**」の考え方をベースに設計されています。  
大規模なDDDの厳格な分離を避け、NestJSが提供する標準的な構造を最大限に活用することで、**最速デプロイ**と**迅速な機能追加**を目指します。

### この思想のメリット

* **最速の開発速度**
  * 関連するコード（Controller, Service, DBアクセス）がモジュール内にフラットに配置されるため、ファイル間の移動が少なく、機能の実装が最も速く進みます。
* **Worker環境への特化**
    * Node.jsの組み込みモジュールを代替するシムファイル群を専用フォルダにまとめることで、アプリケーションコードとインフラ適応コードの分離を明確にしています。
* **NestJSとの高親和性**
    * NestJSが推奨するモジュールとサービスのパターンに忠実であり、学習コストが低く、新しい開発者でもすぐにコードベースを理解できます。

---

## ディレクトリ構成と各コンポーネントの役割

本プロジェクトは、**モジュールごと（関心ごと）** に機能を分割する「関心駆動な構成」を採用し、サービス内でロジックとデータアクセスを統合しています。

### ディレクトリ構成
最終的に採用された構成は以下の通りです。
```
/src
├── main.ts                       # NestJSのエントリポイントとなるファイル
├── app.module.ts                 # NestJSの大元のモジュール
├── worker.ts                     # Cloudflare Workersの実行エントリーポイント（fetchハンドラ）
│
├── /shim                         # Node.js組み込みモジュールの代替実装（async_hooks, stream, cryptoなど）
│   └── (*-shim.ts ファイル群)
│
├── /firebase                     # Firebase連携に必要なサービスの集約
│   └── firebase.service.ts       # Firebase Web SDKの初期化とクライアントインスタンスの提供
│
└── /<module-name> (例: /todos)   # 機能単位のモジュール群
    ├── todos.module.ts           # Todo機能のコントローラーとサービスを定義
    ├── todos.controller.ts       # HTTPリクエストの受付・処理
    ├── todos.service.ts          # アプリケーションロジックとDBアクセスの中核
    ├── todos.dto.ts              # リクエスト/レスポンスのデータ転送オブジェクト
    └── todos.entity.ts           # アプリケーション内で扱うデータ構造
```

### コンポーネントの役割

| コンポーネント | 役割 | 責務 |
| :--- | :--- | :--- |
| **Controller (`todos.controller.ts`)** | **入力層** | HTTPリクエストを受け付け、入力値の検証後、アプリケーションサービスを呼び出す。ビジネスロジックは持たない。 |
| **Service (`todos.service.ts`)** | **アプリケーション/データアクセス層** | ユースケースを実現する。**ビジネスロジックとFirebaseへの具体的なデータアクセス処理を統合**し、全ての処理の中核を担う。 |
| **Firebase Service (`firebase.service.ts`)** | **外部連携層** | Firebase Web SDKの初期化、認証情報の管理、Workers環境下でのDBクライアント提供のみを行う。 |
| **DTO (`todos.dto.ts`)** | **データ転送オブジェクト** | データのやり取りの橋渡しをする。バリデーションを行い、外部とのデータ送受信の形式を統一する。 |

---

## Workers環境への適応

本プロジェクトのデプロイ成功は、以下の**シムファイル**群によって実現されています。

### Shim レイヤーの役割

Cloudflare Workersランタイムが持たないNode.jsの組み込みモジュール（`stream`, `async_hooks`, `crypto`, `os` など）へのNestJSからの参照を、**カスタムで作成したダミーの実装**に置き換えることで、実行時エラーを回避しています。

* **esbuild の `--alias`** オプションが、これらのシムファイルへのリダイレクトを担当しています。
* この層があるおかげで、アプリケーションコード（`/todos`）はWorkersの制約を意識することなく記述できます。

---

## 主な使用ライブラリと選定理由

| ライブラリ | 役割 | 選定理由 |
| :--- | :--- | :--- |
| **NestJS** | バックエンドフレームワーク | TypeScript、モジュールベース、DIコンテナを標準で備え、Workers上で高効率なAPIを構築するために採用。 |
| **esbuild** | バンドラー | Workersの制約に対応するため、高速かつ強力なバンドル、特にNode.jsモジュールをシムに置き換えるエイリアス機能を利用するために採用。 |
| **Firebase (Firestore/DB)** | データベース | フルマネージドなNoSQL DBであり、HTTP/SベースのWeb SDKを通じてWorkers環境からのアクセスが容易であるため採用。 |
